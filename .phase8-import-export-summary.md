# Phase 8: Import/Export System Implementation Summary

## Overview
Successfully implemented a comprehensive Import/Export system for the Worlds project, enabling users to export campaign data as JSON, import data from both Worlds and Kanka formats, and create database backups.

## Files Created

### Controllers
1. **src/Controllers/ExportController.php**
   - `index()` - Display export options page
   - `campaign($id)` - Export entire campaign as JSON
   - `entity($id)` - Export single entity as JSON
   - `backup()` - Download SQLite database backup (admin only)
   - Helper methods:
     - `buildCampaignExport()` - Builds complete campaign export data
     - `buildEntityExport()` - Builds single entity export data
     - `sanitizeFilename()` - Sanitizes filenames for safe downloads
     - `jsonDownload()` - Returns JSON data as downloadable response

2. **src/Controllers/ImportController.php**
   - `showForm()` - Display import form with file upload
   - `preview()` - Preview import data and show mapping/conflicts
   - `process()` - Execute import with conflict resolution
   - `parseKankaJson()` - Parse Kanka export format
   - Helper methods:
     - `parseWorldsJson()` - Parse Worlds native JSON format
     - `detectFormat()` - Auto-detect format (Worlds or Kanka)
     - `extractKankaCustomData()` - Extract custom data from Kanka entities
     - `detectConflicts()` - Detect conflicts with existing data
     - `executeImport()` - Execute import with ID mapping and conflict handling

### Views
3. **src/Views/export/index.php**
   - Purple/magenta themed UI
   - Campaign export section with list of all user campaigns
   - Database backup section (admin only)
   - Recent backups display
   - Help information and navigation

4. **src/Views/import/form.php**
   - Cyan/blue themed UI
   - File upload field (JSON only)
   - Source format selector (Auto-detect, Worlds, Kanka)
   - Import destination options:
     - Create new campaign (with optional name)
     - Import into existing campaign
   - Help tips and information

5. **src/Views/import/preview.php**
   - Import statistics summary (entities, relations, tags, etc.)
   - Entity type breakdown
   - Conflict detection with detailed warnings
   - Conflict resolution strategy selector:
     - Skip conflicting items
     - Overwrite existing
     - Keep both (append "(imported)")
   - Sample entities preview table
   - Import summary with confirmation

### Database Migrations
6. **database/012_add_user_id_to_campaigns.sql**
   - Adds `user_id` column to campaigns table
   - Sets default to user 1 for existing campaigns
   - Creates foreign key to users table
   - Creates index on user_id for performance

7. **database/migrate.sql** (updated)
   - Added `user_id` column to campaigns table definition
   - Added foreign key constraint
   - Added index on user_id

### Configuration Updates
8. **public/index.php** (updated)
   - Added ExportController and ImportController imports
   - Added export routes:
     - GET `/export` - Export options page
     - GET `/export/campaign/{id}` - Export campaign as JSON
     - GET `/export/entity/{id}` - Export entity as JSON
     - GET `/export/backup` - Download database backup
   - Added import routes:
     - GET `/import` - Import form
     - POST `/import/preview` - Preview import data
     - POST `/import/process` - Execute import

9. **src/Config/Response.php** (updated)
   - Modified `download()` method to support both file paths and direct content
   - Now accepts string content with filename and MIME type
   - Maintains backward compatibility with file path mode

## Export Format (JSON)

### Campaign Export Structure
```json
{
  "version": "1.0",
  "format": "worlds",
  "exported_at": "2026-01-28T00:00:00Z",
  "campaign": {
    "name": "Campaign Name",
    "description": "Campaign description",
    "settings": {}
  },
  "entities": [...],
  "relations": [...],
  "tags": [...],
  "entity_tags": [...],
  "attributes": [...],
  "posts": [...]
}
```

### Entity Export Structure
```json
{
  "version": "1.0",
  "format": "worlds",
  "exported_at": "2026-01-28T00:00:00Z",
  "entity": {...},
  "relations": [...],
  "tags": [...],
  "entity_tags": [...],
  "attributes": [...],
  "posts": [...]
}
```

## Kanka Compatibility

### Entity Type Mapping
The system automatically maps Kanka entity types to Worlds types:
- character → character
- location → location
- organisation/organization → organisation
- family → family
- quest → quest
- journal/note → post
- event/timeline → timeline
- calendar → calendar
- race → race
- item → item
- creature → creature
- ability → ability

### Format Detection
The system automatically detects the format by:
1. Checking for `format: "worlds"` marker
2. Checking for `entity_type` field in entities (Worlds format)
3. Defaulting to Kanka if neither is found

## Features Implemented

### Export Features
- ✅ Campaign export as JSON (all entities, relations, tags, etc.)
- ✅ Single entity export as JSON
- ✅ SQLite database backup (admin only)
- ✅ Automatic filename sanitization
- ✅ User authentication and authorization checks
- ✅ Recent backups list display

### Import Features
- ✅ File upload with JSON validation
- ✅ Auto-format detection (Worlds vs Kanka)
- ✅ Import preview with statistics
- ✅ Conflict detection (entity names, tag names)
- ✅ Three conflict resolution strategies:
  - Skip conflicting items
  - Overwrite existing items
  - Keep both (append "(imported)")
- ✅ Create new campaign or import into existing
- ✅ Transactional import (all or nothing)
- ✅ ID mapping for relations and references
- ✅ Entity-tag associations preservation
- ✅ Attributes and posts import
- ✅ Parent-child entity relationships

### Security Features
- ✅ CSRF token validation on all POST requests
- ✅ User authentication required for all operations
- ✅ Campaign ownership verification
- ✅ Admin-only database backups
- ✅ File upload validation (JSON only)
- ✅ Filename sanitization to prevent injection attacks

## Technical Implementation Details

### Transactional Import
All imports are wrapped in database transactions:
- Begin transaction before import
- Create campaign (if new)
- Import tags with ID mapping
- Import entities with ID mapping
- Update parent_id references
- Import relations with mapped IDs
- Import entity-tag associations
- Import attributes and posts
- Commit transaction (or rollback on error)

### ID Mapping
The import system maintains maps of old IDs to new IDs:
- `$entityIdMap` - Maps old entity IDs to new entity IDs
- `$tagIdMap` - Maps old tag IDs to new tag IDs
- Used to preserve relations and references during import

### Conflict Resolution
Three strategies are implemented:
1. **Skip**: Keep existing data, map old ID to existing ID
2. **Overwrite**: Delete existing data, import new data
3. **Keep Both**: Append "(imported)" to name, import as new

## Testing Checklist

### Export Testing
- [ ] Export campaign with entities, relations, and tags
- [ ] Export single entity with all related data
- [ ] Verify JSON format is valid and complete
- [ ] Test database backup (admin user)
- [ ] Verify non-admin users cannot access backup
- [ ] Verify campaign ownership checks work

### Import Testing
- [ ] Import Worlds native export
- [ ] Import Kanka export
- [ ] Test auto-format detection
- [ ] Test conflict detection
- [ ] Test "skip" conflict resolution
- [ ] Test "overwrite" conflict resolution
- [ ] Test "keep both" conflict resolution
- [ ] Test create new campaign option
- [ ] Test import into existing campaign
- [ ] Verify relations are preserved
- [ ] Verify entity-tag associations are preserved
- [ ] Verify attributes and posts are imported
- [ ] Test transaction rollback on error
- [ ] Test with large datasets

## Known Limitations

1. **File Uploads**: The import relies on PHP file upload settings (`upload_max_filesize`, `post_max_size`)
2. **Memory**: Large imports may require increased `memory_limit` in PHP
3. **Files/Images**: Image paths and file attachments are not included in export (only paths are stored)
4. **Users**: User information is not exported with campaigns (campaigns are owner-specific)
5. **Custom Fields**: Some Kanka-specific custom fields may need manual mapping

## Future Enhancements

Potential improvements for future phases:
- [ ] Export/import entity files and images
- [ ] Scheduled automatic backups
- [ ] Export format selection (JSON, CSV, XML)
- [ ] Partial import (select specific entities)
- [ ] Import mapping UI for custom field mapping
- [ ] Export templates with filters
- [ ] Multi-campaign export
- [ ] Version migration handling

## Routes Added

### Export Routes
- `GET /export` - Export options page
- `GET /export/campaign/{id}` - Export campaign as JSON download
- `GET /export/entity/{id}` - Export entity as JSON download
- `GET /export/backup` - Download database backup (admin only)

### Import Routes
- `GET /import` - Display import form
- `POST /import/preview` - Preview import with conflict detection
- `POST /import/process` - Execute import with chosen resolution strategy

## Conclusion

The Import/Export system is fully implemented and ready for testing. All controllers, views, routes, and database schema updates are in place. The system supports both Worlds native format and Kanka format imports, with comprehensive conflict detection and resolution.
